
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Scripts/Datatable/CSS/bootstrap.min.css" rel="stylesheet" />
<link href="~/Scripts/Datatable/CSS/dataTables.bootstrap.min.css" rel="stylesheet" />
<link href="~/Scripts/Datatable/CSS/responsive.bootstrap.min.css" rel="stylesheet" />

<script src="~/Scripts/Datatable/Script/jquery.dataTables.min.js"></script>
<script src="~/Scripts/Datatable/Script/dataTables.bootstrap.min.js"></script>
<script src="~/Scripts/Datatable/Script/datatable.responsive.min.js"></script>
<script src="~/Scripts/Datatable/Script/responsive.bootstrap.min.js"></script>
<script src="~/Scripts/BootAlert.js"></script>

<div class="container-fluid">
    <fieldset>
        <legend>
            <h3><b>Products</b></h3>
        </legend>
    </fieldset>
    <div class="row">
        <div class="col-lg-12">
            <div class="form-horizontal">
                <div class="row">
                    <div class="form-group">
                        <label class="control-label col-sm-2 col-lg-2">Product Name</label>

                        <div class="col-sm-10 col-lg-10">
                            <input type="text" id="txtProdName" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-sm-2 col-lg-2">Product Category</label>

                        <div class="col-sm-5 col-lg-4 col-md-4">
                            <select id="txtCategory" class="SelCategList form-control"></select>
                        </div>
                        <div class="col-sm-5 col-lg-6 col-md-6">
                            <button type="button" id="btnAddCategory" class="btn btn-primary">Add Category</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-sm-2 col-lg-2">
                        </div>
                        <div class="col-sm-10 col-lg-10">
                            <button type="button" id="btnAddProduct" class="btn btn-primary">Save</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-default">
                <div class="panel-body">
                    <table id="tblProducts" class="table table-striped table-bordered nowrap">
                        <thead style="color:ivory;" class="navbar-inverse">
                            <tr>
                                <td>Product Name</td>
                                <td>Category</td>
                                <td>Action</td>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ProductModal" role="dialog">
<div class="modal-dialog modal-md">
    <div class="modal-content">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">
                &times;
            </button>
            <h4 class="modal-title for-add-product">
                Edit Product
            </h4>
            <h4 class="modal-title for-add-category">
                Add Product
            </h4>
        </div>
        <div class="modal-body">
            <div id="divAlert">
            </div>
            <div class="form-horizontal">
                <div id="row">
                    <div class="form-group for-both">
                        <input type="text" readonly="readonly" class="form-control" style="display:none;" id="txtID" name="ID">
                        <label class="control-label col-sm-3 for-add-product">
                            Product Name:
                        </label>
                        <div class="col-sm-9 for-add-product">
                            <input type="text" class="form-control required" id="txtEProductName">
                        </div>
                    </div>
                    <div class="form-group for-both">
                        <label class="control-label col-sm-3">
                            Category:
                        </label>
                        <div class="col-sm-9">
                            <select id="txtECategory" class="SelCategList form-control for-add-product"></select>
                            <input type="text" class="form-control required for-add-category" id="txtCategoryAdd">
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        <div class="modal-footer form-group">
            <button type="button" id="btnUpdateProduct" class="btn btn-primary for-add-product">
                Save
            </button>

            <button type="button" id="btnSaveCategory" class="btn btn-primary for-add-category">
                Save
            </button>

            <button type="button" class="btn btn-default close-button" data-dismiss="modal">
                Cancel
            </button>
        </div>
    </div>
</div>
</div>


<script type="text/javascript">
    var table;
    $(document).ready(function () {
        ProductList();
        CategoryList();

        //Save Product
        $('#btnAddProduct').click(function () {
            
            var param = {
                ProdName: $("#txtProdName").val(),
                CategID: $("#txtCategory").val()
            }

            $.ajax({
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                type: "POST",
                url: "/Product/AddProduct",
                data: JSON.stringify(param),
                success: function (res) {
                    if (res.isError != "T") {
                        alert(res.message);
                        Clear();
                        ProductList();
                    }
                    else {
                        alert(res.message);
                    }
                }
            });
        });

        //Edit Click
        $('#tblProducts tbody').on('click', '.edit', function () {
            $('.for-add-category').hide();
            $('.for-add-product').show();
            $("#ProductModal").modal({
                modal: true, backdrop: 'static', keyboard: false
            });
            var row = $(this).closest("tr");    // Find the row
            var tbProdName = row.find(".pn").text();
            var tbCategName = row.find(".cn").text();

            $("#txtEProductName").val(tbProdName);
            $("#txtECategory selected").text(tbCategName);
            $("#btnUpdateProduct").attr('prodID', $(this).attr('id'));

        });

        //Delete 
        $('#tblProducts tbody').on('click', '.delete', function () {
            var iddelete = $(this).attr("id");

            if (confirm("Are you sure?")) {
                $.ajax({
                    dataType: 'json',
                    type: "POST",
                    url: "/Product/DeleteProduct",
                    data: { productID: iddelete },
                    success: function (res) {
                        if (res.isError != "T") {
                            ProductList();
                        }
                        else {
                        }
                    }
                });
            }
            else {
                return;
            }
        });

        //Save Updated Product
        $('#btnUpdateProduct').click(function () {

            var param = {
                ProdName: $("#txtEProductName").val(),
                CategID: $("#txtECategory").val(),
                ProductID: $("#btnUpdateProduct").attr('prodID')
            }

            $.ajax({
                dataType: 'json',
                contentType: 'application/json; charset=utf-8',
                type: "POST",
                url: "/Product/UpdateProduct",
                data: JSON.stringify(param),
                success: function (res) {
                    if (res.isError != "T") {
                        BootsAlert("success", "Success", res.message, "", "divAlert", "");
                        Clear();
                        ProductList();
                    }
                    else {
                        BootsAlert("danger", "Error", res.message, "", "divAlert", "");
                    }
                }
            });
        });

        //Add Category Click
        $('#btnAddCategory').click(function () {
            $('.for-add-category').show();
            $('.for-add-product').hide();
            $("#ProductModal").modal({
                modal: true, backdrop: 'static', keyboard: false
            });
        });

        //Save Category
        $('#btnSaveCategory').click(function () {
            $.ajax({
                dataType: 'json',
                type: "POST",
                url: "/Product/AddCategory",
                data: { CategName: $('#txtCategoryAdd').val() },
                success: function (res) {
                    if (res.isError != "T") {
                        BootsAlert("success", "Success", res.message, "", "divAlert", "");
                        Clear();
                        ProductList();
                        CategoryList();
                    }
                    else {
                        BootsAlert("danger", "Error", res.message, "", "divAlert", "");
                    }
                }
            });
        });
    });


    function ProductList() {
        table = $("#tblProducts").DataTable({
            ajax: {
                type: "GET",
                url: "/Product/GetProductList",
                dataType: "json",
                "dataSrc": ''
            },
            "bAutoWidth": false,
            "columns": [
                //{ data: "ProductID" },
                { data: "ProdName", className: "pn" },
                { data: "CategName", className: "cn" },
                {
                    data: null,
                    "bSortable": false,
                    "mRender": function (o) {
                        return '<button id=' + o.ProductID + ' class="btn btn-default edit">Edit</button> <button id=' + o.ProductID + ' class="btn btn-default delete">Delete</button>';
                    }
                }
            ],
            responsive: true,
            bDestroy: true
        });
    }
    function CategoryList() {
        $.ajax({
            type: "GET",
            url: "/Product/GetCategoryList",
            success: function (res) {
                $(".SelCategList").html(res);
            }
        });
    }
    function Clear()
    {
        $('#txtProdName').val('');
    }
</script>
